"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"openDatabase",value:function(){return navigator.serviceWorker?idb.open("review-restaurants",2,function(e){switch(e.oldVersion){case 0:var t=e.createObjectStore("restaurants",{keyPath:"id"});t.createIndex("by-cuisine","cuisine_type"),t.createIndex("by-neighborhood","neighborhood");case 1:e.createObjectStore("reviews",{keyPath:"id"}).createIndex("by-restaurant","restaurant_id")}}):Promise.resolve()}},{key:"fetchRestaurants",value:function(){return a.getRestaurantsFromLocal().then(function(e){return e&&e.length?(a.getRestaurantsFromRemote(),e):a.getRestaurantsFromRemote()})}},{key:"getRestaurantsFromLocal",value:function(){return a.openDatabase().then(function(e){if(e)return e.transaction("restaurants").objectStore("restaurants").getAll()})}},{key:"getRestaurantsFromRemote",value:function(){return fetch(a.DATABASE_URL+"/restaurants").then(function(e){return e.json()}).then(function(e){return a.addRestaurantsToIndexDB(e),e})}},{key:"toggleFavoriteRestaurant",value:function(e){return fetch(a.DATABASE_URL+"/restaurants/"+e.id+"/?is_favorite="+e.is_favorite,{method:"PUT"}).then(function(e){return e.json()}).then(function(e){return a.addRestaurantsToIndexDB([e]),e})}},{key:"addRestaurantsToIndexDB",value:function(r){return a.openDatabase().then(function(e){if(e){var t=e.transaction("restaurants","readwrite"),n=t.objectStore("restaurants");return r.forEach(function(e){return n.put(e)}),t.complete}})}},{key:"fetchReviews",value:function(t){return a.getReviewsFromLocal(t).then(function(e){return e&&e.length?(a.getReviewsFromRemote(t),e):a.getReviewsFromRemote(t)})}},{key:"getReviewsFromLocal",value:function(t){return a.openDatabase().then(function(e){if(e)return e.transaction("reviews").objectStore("reviews").index("by-restaurant").getAll(t)})}},{key:"getReviewsFromRemote",value:function(e){return fetch(a.DATABASE_URL+"/reviews/?restaurant_id="+e).then(function(e){return e.json()}).then(function(e){return a.addReviewsToIndexDB(e),e})}},{key:"addNewReview",value:function(e){return fetch(a.DATABASE_URL+"/reviews",{method:"POST",body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){return a.addReviewsToIndexDB([e]),e})}},{key:"addReviewsToIndexDB",value:function(r){return a.openDatabase().then(function(e){if(e){var t=e.transaction("reviews","readwrite"),n=t.objectStore("reviews");return r.forEach(function(e){return n.put(e)}),t.complete}})}},{key:"fetchRestaurantById",value:function(t){return a.openDatabase().then(function(e){if(e)return e.transaction("restaurants").objectStore("restaurants").get(parseInt(t))}).then(function(e){return e||fetch(a.DATABASE_URL+"/restaurants/"+t).then(function(e){return e.json()})})}},{key:"fetchRestaurantByCuisine",value:function(t){return a.fetchRestaurants().then(function(e){return e.filter(function(e){return e.cuisine_type==t})}).catch(function(){return a.openDatabase().then(function(e){if(e)return e.transaction("restaurants").objectStore("restaurants").index("by-cuisine").getAll(t)})})}},{key:"fetchRestaurantByNeighborhood",value:function(t){return a.fetchRestaurants().then(function(e){return e.filter(function(e){return e.neighborhood==t})}).catch(function(){return a.openDatabase().then(function(e){if(e)return e.transaction("restaurants").objectStore("restaurants").index("by-neighborhood")})})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(n,r){return a.fetchRestaurants().then(function(e){var t=e;return"all"!=n&&(t=t.filter(function(e){return e.cuisine_type==n})),"all"!=r&&(t=t.filter(function(e){return e.neighborhood==r})),t})}},{key:"fetchNeighborhoods",value:function(){return a.fetchRestaurants().then(function(n){var r=n.map(function(e,t){return n[t].neighborhood});return r.filter(function(e,t){return r.indexOf(e)==t})})}},{key:"fetchCuisines",value:function(){return a.fetchRestaurants().then(function(n){var r=n.map(function(e,t){return n[t].cuisine_type});return r.filter(function(e,t){return r.indexOf(e)==t})})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/assets/img/"+(e.photograph?e.photograph:"placeholder-image.webp")}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:a.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),a}();